---
services:

  redis:
    image: redis:latest
    container_name: htc-redis
    network_mode: host
    volumes:
      - redis_data:/data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 16G
        reservations:
          memory: 4G

  node1:
    image: uxhabam/hyperbolic-time-chamber:1.9.3
    container_name: node_1
    depends_on:
      - redis
    hostname: node1
    network_mode: host
    environment:
      CLUSTER_PORT: 1600
      CLUSTER_IP: 127.0.0.1
      CLUSTER_NAME: node1
      SEED_PORT_1600_TCP_ADDR: 127.0.0.1
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379
      MANAGEMENT_HTTP_PORT: 8558
      HTC_SIMULATION_CONFIG_FILE: /app/hyperbolic-time-chamber/simulations/input/cenario_3.0M_viagens/simulation.json
      HTC_MOBILITY_CITY_MAP_FILE: /app/hyperbolic-time-chamber/simulations/input/cenario_3.0M_viagens/data/city_map.json
      # Otimizado para single node (112 threads, 1TB RAM)
      # Suporta 3-12M trips com heap 640GB
      HTC_TIME_MANAGER_INSTANCES: 192               # reduced to lower memory footprint
      HTC_TIME_MANAGER_PER_NODE: 192
      HTC_TIME_MANAGER_SNAPSHOT_INTERVAL: 15000     # fewer snapshots during heavy load
      HTC_TIME_MANAGER_ACTOR_TIMEOUT_MS: 300000
      HTC_TIME_MANAGER_SYNC_TIMEOUT_MS: 60000
      HTC_TIME_MANAGER_STALE_EVENT_MAX_AGE_MS: 60000
      HTC_TIME_MANAGER_HEALTH_CHECK_INTERVAL: 120
      # Reporters otimizados (CSV consome muita memÃ³ria)
      HTC_REPORT_CSV_INSTANCES: 0                   # disable CSV to avoid memory overhead
      HTC_REPORT_CSV_PER_NODE: 0
      HTC_REPORT_JSON_INSTANCES: 32                 # fewer JSON reporters
      HTC_REPORT_JSON_PER_NODE: 32
      # JVM Options - keep large heap, add GC logging to mapped logs dir
      JAVA_OPTS: >-
        -Xms512g
        -Xmx800g
        -XX:+UseG1GC
        -XX:MaxGCPauseMillis=300                    # allow slightly longer pauses
        -XX:G1HeapRegionSize=32m
        -XX:InitiatingHeapOccupancyPercent=35       # start concurrent cycles earlier
        -XX:G1ReservePercent=20                     # more headroom to avoid promotion failure
        -XX:+ParallelRefProcEnabled
        -XX:+AlwaysPreTouch
        -XX:+UseStringDeduplication
        -XX:+HeapDumpOnOutOfMemoryError
        -XX:HeapDumpPath=/app/hyperbolic-time-chamber/logs/heap-dump-single-node.hprof
        -XX:+ExitOnOutOfMemoryError
        -Xlog:gc*:file=/app/hyperbolic-time-chamber/logs/gc.log:time,level,tags
        -Dpekko.actor.default-dispatcher.fork-join-executor.parallelism-min=56
        -Dpekko.actor.default-dispatcher.fork-join-executor.parallelism-max=112
        -Dpekko.actor.default-dispatcher.fork-join-executor.parallelism-factor=1.0
    volumes:
      - /home/fwrocha/phd/simulator/htc:/app/hyperbolic-time-chamber
      - /home/dean/PhD/hyperbolic-time-chamber/logs:/app/hyperbolic-time-chamber/logs   # ensure logs dir exists
    deploy:
      resources:
        limits:
          memory: 880G
          cpus: '112'
        reservations:
          memory: 512G
          cpus: '56'

volumes:
  redis_data: